\begin{appendix}

    \renewcommand{\thefigure}{A\arabic{figure}}
    \setcounter{figure}{0}
    
    \renewcommand{\thetable}{A\arabic{table}}
    \setcounter{table}{0}
    
    \renewcommand{\theequation}{A\arabic{equation}}
    \setcounter{equation}{0}

    \newpage

    \section{Appendix}

    \subsection{Day zero designs} \label{sec:dayzero}
    In the main text, we discussed two trial designs starting on postexposure day zero. In the first, participants are enrolled on postexposure day zero, randomized, and immediately administered either vaccine or no vaccine with the goal of estimating the $\Delta$-day vaccine efficacy in the ideal case in which there is no delay between exposure and vaccination. Under perfect adherence this trial targets the estimand
    $$VE(0) = 1 - \frac{\Pr[Y^{x = 0} = 1]}{\Pr[Y^{x > \Delta} = 1]}$$
    which is likely an upper bound on vaccine efficacy under more plausible scenarios of delay. 

    In the second design, participants are still enrolled and randomized on postexposure day zero, but they are then further randomly assigned a postexposure date to receive the vaccine.  Under perfect adherence, the casual contrast of interest is now the $t$-specific vaccine efficacy
    $$VE(t) = 1 - \frac{\Pr[Y^{x = t} = 1]}{\Pr[Y^{x > \Delta} = 1]}.$$
    which could be used, for instance, to determine the time window public health officials and policymakers should advise individuals at risk of exposure to seek vaccination within if they are exposed (see Section \ref{sec:maxdelay}).

    \subsection{Fixed enrollment period designs} \label{sec:enrollment}

    Also mentioned in the main text, when the timing of vaccination is not under the strict control of the investigator, a possible design is to specify a fixed time window in which participants are eligible to be vaccinated and randomize them on the postexposure day they present. Under perfect adherence, this design could then target the $t$-specific vaccine efficacy among those presenting symptom-free, i.e.
    $$
    VE_{T > t}(t) = 1 - \frac{\Pr[Y^{x = t} = 1 \mid X \geq t, T > t]}{\Pr[Y^{x > \Delta} = 1 \mid X \geq t, T > t]} \\
    $$
    by comparing vaccine and no vaccine groups within enrollment  strata. Note that, in general, the $t$-specific vaccine efficacies, $VE_{T > t}(t)$, targeted in this trial will not be the same as the $VE(t)$ defined previously as they are conditional on presentation time and being symptom-free at enrollment. More often, in practice, the $t$-specific estimates $VE_{T > t}(t)$ are pooled together into a weighted average efficacy over the enrollment period. However, we stress caution in interpreting pooled estimates. Because participants are allowed to present naturally rather than being assigned a time at day zero, those that present earlier may be systematically different than those presenting later with respect to their risk of developing clinical disease. Therefore the pooled estimates are among a subpopulation who survive symptom-free and may not generalize to other populations with different propensities for delay. 

    \subsection{Grace period designs} \label{sec:graceperiod}

    An alternative design which also allows for delays in vaccination is to specify a \textit{grace period}, i.e. a fixed time window after randomization in which vaccination can be initiated. For example, in a postexposure trial of a varicella vaccine, the investigators stipulated that sibling contacts of varicella case were ``were identified by their primary pediatrician and referred to our department \textit{within 72 hours} of the appearance of the first skin lesion'' in the index case. Under this design, the causal target would be the average vaccine effectiveness during the $\delta$ days of the grace period, i.e.
    $$
    \overline{VE}_\delta = 1 - \frac{\Pr[Y^{g(X,\delta)} = 1]}{\Pr[Y^{x > \Delta} = 1]}
    $$ 
    where
    \begin{gather*}
        g(X,\delta): \text{get vaccinated within $\delta$ days of exposure under the expected vaccine } \\ \text{ administration pattern }  f^*(X \mid \overline{L}_t, X > t, T > t)
    \end{gather*}
    where, for instance, in the varicella trial $\delta = 3$. Although in theory randomization could occur on any postexposure day followed by $\delta$-day grace period, in practice grace periods starting from randomization on day zero are probably the most relevant. When effectiveness varies by the time since exposure, as it most certainly does for most postexposure vaccines, a design with as grace design estimates the average effectiveness \textit{under the ``natural'' time course of vaccination}, $f^*(X \mid \overline{L}_t, X > t, T > t) = f(X \mid \overline{L}_t, X > t, T > t)$. This implies that two trials identical in all respects except for the distribution of vaccinations over the grace period could yield substantially different estimates. Therefore, a trialist pursuing this design has to strike a balance when defining a grace period between ensuring the period is short enough that benefit is immunologically possible and the trial is adequately powered, but also long enough that the regime is clinically feasible under reasonable assumptions about how quickly patients are notified of their exposure to a case and can access a vaccine in the real world. Properly conceived a grace period design can provide evidence about average effectiveness of postexposure vaccination administered within a certain window under real world conditions. As such it may be a more useful estimate for population planning or modeling studies than those produced by the stratified design above. When there's no effect modification by initiation or onset time, the average effectiveness is equal to $VE(t)$ standardized over the distribution of vaccine administration times during the grace period, i.e.
    $$\overline{VE}_\delta = \sum_{t = 1}^\delta VE(t) \times f^*_X(t \mid \overline{L}_t, X > t, T > t).$$

    \subsection{Additional emulation details} \label{sec:datamanip}
    Here, we demonstrate the data manipulation steps to emulate the three trial designs ---day zero, fixed enrollment period, and grace period--- discussed above using observational data. These steps are necessary for emulating the analysis that would have been conducted in the ideal trial. As in all observational research, additional untestable assumptions, notably exchangeability, consistency, and positivity, will also be required to ensure that the effect estimated from the observational data is equivalent to that which would be estimated in a randomized trial (accounting for sampling variability). 

    Two crucial differences between a randomized trial and an observational study are that 1) the former has a well defined start of follow up, or \textit{time zero}, from which study outcomes are assessed and 2) all participants are assigned a particular treatment strategy. By contrast observational studies generally do not have a uniquely defined time zero and participants may have data consistent with multiple treatment strategies. Therefore, when emulating a trial certain data manipulations are often applied to the observational data to solve these issues. 

    When emulating a fixed enrollment period design, the problem is that participants in the observational data often meet the eligibility criteria at multiple time points, that is there is no uniquely defined time zero from which to start follow up. For instance, consider a postexposure vaccination trial in which participants are eligible anytime in the first 5 days after exposure if they have no previous vaccination history and no symptoms at presentation. In a real trial the participant would be enrolled and randomized on a particular day and that will be their time zero. In the observational data, a participant may meet these criteria continuously, for instance between days 0 and 4. The question is then when should their follow-up start? On day 0, 1, 2, 3, or 4? The choice has to be applied equivalently to vaccinated and unvaccinated participants to avoid \textit{immortal time bias}. One possibility is to randomly choose a start time among the days they are eligible. However, a more efficient choice is to use every eligible time by emulating a sequence of multiple nested target trials each with a different start. A natural choice for postexposure vaccination for a pathogen with a relatively short incubation period is to emulate a series of daily nested trials, i.e. on day zero condition on those who meet the eligibility criteria and compare those who are vaccinated on that day to those who are unvaccinated on that day, and then repeat on all days within the fixed enrollment period (schematic Figure \ref{fig:design1}). Participants in the observational study can be enrolled in trials starting on multiple days as long as they meet the eligibility criteria.
    
    To demonstrate the required data manipulation steps, consider the six individuals shown in Table \ref{tab:example1} with vaccination and symptom onset times recorded during a hypothetical observational study. To emulate a trial with a fixed five day enrollment period postexposure, we create one copy of the dataset for each trial day. Then in each copy we apply the proper eligibility criteria (e.g. individuals should be disease-free and not vaccinated on a previous day) and assign those vaccinated on that trial day to be ``vaccinated'' and those who have not been vaccinated yet to be ``unvaccinated''. For example, individual 2 in Table \ref{tab:example1} is vaccinated on on day 2 and doesn't develop symptoms, therefore in the emulation they will participate in 3 trials (i.e. those starting on postexposure day 0, 1, and 2). In trials starting after postexposure day 2 they are no longer eligible because they have already been vaccinated. In each trial, follow up time is adjusted to start on the postexposure day of interest and end either at symptom onsent or at the maximum follow up day which may be fixed from the index exposure day or be of fixed length from the trial day. In per protocol analyses, individuals in each nested trial are censored when they deviate from their baseline assignment in that trial. For example, individual 3 in Table \ref{tab:example1} is unvaccinated in trials starting on days 0 through 3, but in each of these trials is censored on day 4 in the per protocol analysis because they deviate from their baseline assignment by becoming vaccinated.
    
    \begin{table}[t]
        \small
        \centering
        \caption{Enrollment of six hypothetical individuals in daily nested trials for 5-day vaccination window based on observed data.\label{tab:example1}}
        \begin{tabular}{cC{0.9in}C{0.9in}C{1in}C{1in}C{0.9in}C{0.9in}}
        \toprule
        \makecell[c]{ID} & \makecell[c]{Vaccination \\ (1: yes, 0: no)} & \makecell[c]{Day of \\ vaccination} & \makecell[c]{Clinical disease \\ (1: yes, 0: no)} & \makecell[c]{Day of \\ disease onset} & \makecell[c]{No. of trials \\ enrolled} \\
        \midrule
            1 & 1 & 0 & 0 & - & 1 (0) \\
            2 & 1 & 2 & 0 & - & 3 (0-2) \\
            3 & 1 & 4 & 1 & 8 & 5 (0-4) \\
            4 & 1 & 7 & 1 & 3 & 4 (0-3) \\
            5 & 0 & - & 0 & - & 6 (0-5) \\
            6 & 0 & - & 1 & 5 & 6 (0-5) \\
        \bottomrule
        \end{tabular}
    \end{table}

    Once we have completed the necesary data manipulation steps to emulate the nested sequence of trials, analysis of both the intent-to-treat and per-protocol effects of postexposure vaccination can be conducted as described in the main text. One approach would be to estimate the $t$-specific $VE_{T > t}(t)$ separately in each nested trial. However, this assumes we observe sufficient numbers of individuals receiving a vaccine on each day to obtain reliable estimates. In practice, we can increase efficiency by pooling across trials and fitting a model such as
    \begin{equation}\Pr[D_{t+1} = 1 \mid D_t = 0, X, Z, L_t] =  \operatorname{expit}\{\psi_0 \lambda(X + t) + \psi_1 Z f(X) + \psi_2 L_t\}
    \end{equation}\label{eqn:fixed}
    where $\lambda(X + t)$ is the unvaccinated odds of symptom onset,  $Z$ is an indicator of baseline ``assignment'' in the trial, $X$ is the postexposure day that the trial starts, $L_t$ is a vector of baseline covariates sufficient to ensure exchangeability at baseline, $t$ is follow up time counting from $X$, and $f(X)$ is a function of vaccination day. We can allow $f(X)$ and $\lambda(X + t)$ to be a member of a class of flexible such as restricted cubic splines. The $\widehat{VE}_{T > t}(t)$ curve can be estimated either from the hazard ratios or from standardized cumulative incidence curves depending on effect measure of interest. To estimate per protocol effects we censor participants when their data deviates from their ``assigned'' regime and then adjust for possible time-varying selection bias using any g-method such as inverse-probability of censoring weights. Additionally, because we are using the same participant in multiple nested trials our observations are no longer independent. Therefore appropriate adjustment to our standard errors is necessary to account for possible correlation across observations. Adjustment can be made either by using a cluster-robust variance estimator or the bootstrap. 

    When emulating a day zero trial in which participants are randomized to a particular delay, the problem is instead that participants in the observational data will have data consistent with multiple treatment regimes. Consider a trial where participants are randomized on day zero to one of the following strategies: (1) receive vaccine on day zero, (2) receive vaccine on day one, (3) receive vaccine on day two, (4) receive vaccine on day three, or (5) to receive no vaccine over the follow up period (schematic Figure \ref{fig:design2}). In a real trial participants would be assigned to one of the five regimes at the start. In the observational data, however, some individuals will get vaccinated on day 0 and therefore only have data compatible with the first strategy, but others will not get vaccinated on day zero and will have data compatible with multiple strategies at baseline. The question is now which strategy should we assign them to? As in the sequential design, one option is to pick a single strategy at random from the strategies their data is consistent with. However, again the more efficient choice is to assign them to all possible strategies by creating exact copies ---often called clones--- of each of these individuals in the dataset and assign each clone to a different strategy. 

    To demonstrate the required data manipulation steps, let's return to the six hypothetical individuals from Table \ref{tab:example1}, but now in Table \ref{tab:example2} we will use their data to emulate a day zero trial in which participants are randomized to strategies (1)-(5) in previous paragraph. Starting with the first individual, they are vaccinated on day zero and therefore have data consistent only with strategy (1), thus they are not cloned. The second individual, however, is not vaccinated until day 2 and therefore at time zero they have data consistent with any of the strategies (1)-(5), thus we make five clones of the second individual by copying their data five times and assigning each observation to a different regime. We then follow each clone forward and censor them when they deviate from their assigned regime. For instance, we know the second individual is vaccinated on day 2, therefore on day 2 we censor all clones except the one assigned to strategy (3). Importantly, if the individual has symptoms before any clone is censored, as is the case for individual 4, then all clones will have symptoms and therefore the case is assigned to all strategies. This multiple allocation of events prevents the bias that could arise if events occurring during the delay period are systematically assigned to one of the five strategies only.

    \begin{table}[t]
        \small
        \centering
        \caption{Emulation of day zero trial with five vaccination delay strategies using data from six hypothetical individuals.\label{tab:example2}}
        \begin{tabular}{cC{0.9in}C{0.9in}C{1in}C{1in}C{0.9in}}
        \toprule
        \makecell[c]{ID} & \makecell[c]{Vaccination \\ (1: yes, 0: no)} & \makecell[c]{Day of \\ vaccination} & \makecell[c]{Clinical disease \\ (1: yes, 0: no)} & \makecell[c]{Day of \\ disease onset} & \makecell[c]{No. of regimes \\ followed} \\
        \midrule
            1 & 1 & 0 & 0 & - & 1 (1) \\
            2 & 1 & 2 & 0 & - & 5 (1-5) \\
            3 & 1 & 4 & 1 & 8 & 5 (1-5) \\
            4 & 1 & 7 & 1 & 3 & 5 (1-5) \\
            5 & 0 & - & 0 & - & 5 (1-5) \\
            6 & 0 & - & 1 & 5 & 5 (1-5) \\
        \bottomrule
        \end{tabular}
    \end{table}

    To analyze the data from the emulated day zero trial, we could estimate the $VE(t)$ separately by comparing each delay strategy, e.g. (1)-(4), to the ``never vaccinate'' strategy (5). Once again, however, we could increase efficiency by pooling across trials and fitting a model such as
    \begin{equation}
        \Pr[D_{t+1} = 1 \mid D_t = 0, Z, L_t] =  \operatorname{expit}\{\psi_0 \lambda(t) + \psi_1f(Z) + \psi_2 L_t\}
    \end{equation} \label{eqn:dayzero}
    where $Z$ is now a discrete variable with levels for each delay regime (with 0 being the ``never vaccinate'' strategy) and other variables are defined as previously. As previously, the $\widehat{VE}(t)$ curve can be estimated either from the hazard ratios or from standardized cumulative incidence curves depending on effect measure of interest. Adjustment for the nonindepence of the cloned observations can be made either by using a cluster-robust variance estimator or the bootstrap. 

    Finally, when emulating the grace period design the challenges are similar to those in the day zero trial in which participants are randomized to a delay strategy, i.e. some participants in the observational study have data consistent with multiple regimes. Consider a trial where participants are randomized at day zero to either (1) receive vaccine sometime within the first five days postexposure or (2) to receive no vaccine over the follow up period (schematic Figure \ref{fig:design3}). Once again, if the trial were actually conducted everyone would have an unambiguous assignment at time zero. However, in the observational data individuals who receive vaccine after day zero have data consistent with both strategies in the period before receiving the vaccine. This is important when considering some individuals may acquire symptoms prior to receiving vaccination during the grace period, in which case to which strategy should they be assigned? The solution, as before, is to create clones when individuals have data consistent with multiple regimes, assign each clone to a regime, and then censor them if they deviate from their assigned regime. 

    To demonstrate the required data manipulation steps, we return again to the same six hypothetical individuals, but now in Table \ref{tab:example3} we will use their data to emulate a trial with a five day grace period. Starting with the first individual, they are vaccinated on day zero and therefore have data consistent only with strategy (1) and therefore they are not cloned. The second individual, however, is not vaccinated until day 2 and therefore at time zero has data consistent both strategies (1) and (2), thus we make two clones of the second individual by copying their data and assigning each observation to one of the two regimes. We then follow each clone forward and censor them when they deviate from their assigned regime. For instance, we know the second individual is vaccinated on day 2, therefore on day 2 we censor the clone assigned to regime (2), i.e. receive no vaccine over the follow up period. Again, if the individual has symptoms before any clone is censored, as is the case for individual 4, then all clones will have symptoms and therefore the case is assigned to all strategies strategies. This double allocation of events prevents the bias that could arise if events occurring during the grace period are systematically assigned to one of the two strategies only. 

    \begin{table}[t]
        \small
        \centering
        \caption{Emulation of trial with five day grace period vaccination using data from six hypothetical individuals.\label{tab:example3}}
        \begin{tabular}{cC{0.9in}C{0.9in}C{1in}C{1in}C{0.9in}}
        \toprule
        \makecell[c]{ID} & \makecell[c]{Vaccination \\ (1: yes, 0: no)} & \makecell[c]{Day of \\ vaccination} & \makecell[c]{Clinical disease \\ (1: yes, 0: no)} & \makecell[c]{Day of \\ disease onset} & \makecell[c]{No. of regimes \\ followed} \\
        \midrule
            1 & 1 & 0 & 0 & - & 1 (1) \\
            2 & 1 & 2 & 0 & - & 2 (1-2) \\
            3 & 1 & 4 & 1 & 8 & 2 (1-2) \\
            4 & 1 & 7 & 1 & 3 & 2 (1-2) \\
            5 & 0 & - & 0 & - & 2 (1-2) \\
            6 & 0 & - & 1 & 5 & 2 (1-2) \\
        \bottomrule
        \end{tabular}
        \end{table}

    To analyze the emulated grace period design, we can estimate the average vaccine effectiveness over the grace period $\overline{VE}_\delta$ by fitting the model 
    $$\Pr[D_{t+1} = 1 \mid D_t = 0, Z, L_t] =  \operatorname{expit}\{\psi_0 \lambda(t) + \psi_1 Z + \psi_2 L_t\}$$
    where $Z$ is an indicator of the vaccination strategy and the other variables are defined as previously. As previously, the $\overline{VE}_\delta$ curve can be estimated either from the hazard ratios or from standardized cumulative incidence curves depending on effect measure of interest. When analyzing designs with grace periods, the intention-to-treat effect cannot be estimated because almost everyone will contribute a clone to each of the treatment strategies. Because each individual is assigned to all strategies at baseline, a contrast based on baseline assignment (i.e., an ``intention-to-treat analysis'') will compare groups with essentially identical outcomes. Therefore, analyses with grace period at baseline are geared towards estimating some form of per-protocol effect. To estimate per protocol effects, we again censor participants when their data deviates from their ``assigned'' regime and then adjust for possible time-varying selection bias using any g-method such as inverse-probability of censoring weights. Note that, to emulate a well-defined vaccination strategy the expected rate of vaccination over the grace period $f^*(X \mid \overline{L}_t, X > t, T > t)$ should be specified and then the per-protocol effect under this vaccination strategy can be emulated by multiplying the inverse probability weights by a suitable factor. Finally, as with the day zero design adjustment for the nonindepence of the cloned observations can be made either by using a cluster-robust variance estimator or the bootstrap. 

    

    

    \newpage 
    \clearpage
    \begin{figure}[p]
    \centering
    \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 1.5cm, thick]
    
    \node[circle,draw=none] (y0) {$Y$};
    \node[circle,draw=none] (y1) [below of=y0] {$Y$};
    \node[circle,draw=none] (y2) [below of=y1] {$Y$};
    \node[circle,draw=none] (y3) [below of=y2] {$Y$};
    \node[circle,draw=none] (d) [below of=y3] {\large $\vdots$};
    \node[circle,draw=none] (y4) [below of=d] {$Y$};
    \node[circle,draw=none] (y5) [below of=y4] {$Y$};

    \node[circle,draw,minimum size =1cm] (a03) [left of=y0] {$1$};
    \node[circle,draw,minimum size =1cm] (a02) [left of=a03] {$1$};
    \node[circle,draw,minimum size =1cm] (a01) [left of=a02] {$1$};
    \node[circle,draw,minimum size =1cm] (a0)  [left of=a01] {$1$};

    \node[circle,draw,minimum size =1cm] (a13) [left of=y1] {$0$};
    \node[circle,draw,minimum size =1cm] (a12) [left of=a13] {$0$};
    \node[circle,draw,minimum size =1cm] (a11) [left of=a12] {$0$};
    \node[circle,draw,minimum size =1cm] (a1)  [left of=a11] {$0$};

    \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l0) [below left=0.01cm and 1.5cm of a0] {$ $};  
    
    \node[circle,draw=none] (day0) [left= 1cm of l0] {Trial $0$};

    \path[->] (l0) edge node {} (a0);
    \path[->] (l0) edge node {} (a1);
    \path[->] (a0) edge node {} (a01);
    \path[->] (a1) edge node {} (a11);

    \path[->] (a11) edge node {} (a12);
    \path[->] (a12) edge node {} (a13);
    \path[->] (a13) edge node {} (y1);

    \path[->] (a01) edge node {} (a02);
    \path[->] (a02) edge node {} (a03);
    \path[->] (a03) edge node {} (y0);

    \node[circle,draw,minimum size =1cm] (a23) [left of=y2] {$1$};
    \node[circle,draw,minimum size =1cm] (a22) [left of=a23] {$1$};
    \node[circle,draw,minimum size =1cm] (a21) [left of=a22] {$1$};

    \node[circle,draw,minimum size =1cm] (a33) [left of=y3] {$0$};
    \node[circle,draw,minimum size =1cm] (a32) [left of=a33] {$0$};
    \node[circle,draw,minimum size =1cm] (a31) [left of=a32] {$0$};

    \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l11) [below left=0.01cm and 1.5cm of a21] {$ $};  
    \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l10) [left of=l11] {$ $};  

    \node[circle,draw=none] (day1) [left= 1cm of l10] {Trial $1$};

    \path[->] (l11) edge node {} (a21);
    \path[->] (l11) edge node {} (a31);

    \path[->] (a21) edge node {} (a22);
    \path[->] (a22) edge node {} (a23);
    \path[->] (a23) edge node {} (y2);

    \path[->] (a31) edge node {} (a32);
    \path[->] (a32) edge node {} (a33);
    \path[->] (a33) edge node {} (y3);

    \node[circle,draw=none] (dd) [below of=a32] {\large $\ddots$};

    \node[circle,draw=none] (dv) [left=4.1cm of dd] {\large $\vdots$};

    \node[circle,draw,minimum size =1cm] (a43) [left of=y4] {$1$};

    \node[circle,draw,minimum size =1cm] (a53) [left of=y5] {$0$};

    \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l33) [below left=0.01cm and 1.5cm of a43] {$ $};  
    \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l32) [left of=l33] {$ $};  
    \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l31) [left of=l32] {$ $};  
    \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l30) [left of=l31] {$ $};  

    \node[circle,draw=none] (dayd) [left= 1cm of l30] { Trial $\delta$};

    \path[->] (l33) edge node {} (a43);
    \path[->] (l33) edge node {} (a53);

    \path[->] (a43) edge node {} (y4);
    \path[->] (a53) edge node {} (y5);

    \end{tikzpicture}
   
    \caption{Schematic of nested daily trial design, on each day participants are assigned to vaccine or no vaccine, possibly conditional on their history up to that day. Squares represent a pool of participants eligible for randomization; circles represent the status of individuals who have been randomized. Time moves from left to right. }
    \label{fig:design1}
    \end{figure}

    \clearpage
    \begin{figure}[p]
        \centering
        \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 1.5cm, thick]

            \node[circle,draw=none] (y0) {$Y$};
            \node[circle,draw=none] (y1) [below of=y0] {$Y$};
            \node[circle,draw=none] (y2) [below of=y1] {$Y$};
            \node[circle,draw=none] (y3) [below of=y2] {$Y$};
            \node[circle,draw=none] (y4) [below of=y3] {$Y$};
        
            \node[circle,draw,minimum size =1cm] (a03) [left of=y0] {$1$};
            \node[circle,draw,minimum size =1cm] (a02) [left of=a03] {$1$};
            \node[circle,draw,minimum size =1cm] (a01) [left of=a02] {$1$};
            \node[circle,draw,minimum size =1cm] (a0)  [left of=a01] {$1$};
        
            \node[circle,draw,minimum size =1cm] (a13) [left of=y1] {$1$};
            \node[circle,draw,minimum size =1cm] (a12) [left of=a13] {$1$};
            \node[circle,draw,minimum size =1cm] (a11) [left of=a12] {$1$};
            \node[circle,draw,minimum size =1cm] (a1)  [left of=a11] {$0$};
            
        
            \path[->] (a0) edge node {} (a01);
            \path[->] (a1) edge node {} (a11);
        
            \path[->] (a11) edge node {} (a12);
            \path[->] (a12) edge node {} (a13);
            \path[->] (a13) edge node {} (y1);
        
            \path[->] (a01) edge node {} (a02);
            \path[->] (a02) edge node {} (a03);
            \path[->] (a03) edge node {} (y0);
        
            \node[circle,draw,minimum size =1cm] (a23) [left of=y2] {$1$};
            \node[circle,draw,minimum size =1cm] (a22) [left of=a23] {$1$};
            \node[circle,draw,minimum size =1cm] (a21) [left of=a22] {$0$};
            \node[circle, draw, minimum size =1cm] (a20) [left of=a21] {$0$}; 
    
            \node[circle,draw,minimum size =1cm] (a33) [left of=y3] {$1$};
            \node[circle,draw,minimum size =1cm] (a32) [left of=a33] {$0$};
            \node[circle,draw,minimum size =1cm] (a31) [left of=a32] {$0$};
            \node[circle, draw, minimum size =1cm] (a30) [left of=a31] {$0$};  
     
            \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l0) [left=1.5cm of a20] {$ $};  
    
            \path[->] (l0) edge node {} (a0);
            \path[->] (l0) edge node {} (a1);
            \path[->] (l0) edge node {} (a20);
            \path[->] (l0) edge node {} (a30);
    
            \path[->] (a20) edge node {} (a21);
            \path[->] (a21) edge node {} (a22);
            \path[->] (a22) edge node {} (a23);
            \path[->] (a23) edge node {} (y2);
    
            \path[->] (a30) edge node {} (a31);
            \path[->] (a31) edge node {} (a32);
            \path[->] (a32) edge node {} (a33);
            \path[->] (a33) edge node {} (y3);
        
            \node[circle,draw,minimum size =1cm] (a43) [left of=y4] {$0$};
            \node[circle, draw, minimum size =1cm] (a42) [left of=a43] {$0$};  
            \node[circle, draw, minimum size =1cm] (a41) [left of=a42] {$0$};  
            \node[circle, draw, minimum size =1cm] (a40) [left of=a41] {$0$};  
    
        
            \path[->] (l0) edge node {} (a40);
        
            \path[->] (a40) edge node {} (a41);
            \path[->] (a41) edge node {} (a42);
            \path[->] (a42) edge node {} (a43);
            \path[->] (a43) edge node {} (y4);
    
            \end{tikzpicture}
            \caption{Schematic of trials in which participants are randomized on day zero to a specific vaccination delay strategy.}
            \label{fig:design2}
    \end{figure}

    \begin{figure}[p]
        \centering
        \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 1.5cm, thick]

            % \node[circle,draw=none] (y0) {$Y$};
            % \node[circle,draw=none] (y1) [below of=y0] {$Y$};
            % \node[circle,draw=none] (y2) [below of=y1] {$Y$};
            % \node[circle,draw=none] (y3) [below of=y2] {$Y$};
            % \node[circle,draw=none] (d) [below of=y3] {\large $\vdots$};
            \node[circle,draw=none] (y4) {$Y$};
            \node[circle,draw=none] (y5) [below of=y4] {$Y$};
        
            \node[circle,draw,minimum size =1cm] (a43) [left of=y4] {$1$};
            \node[circle, draw, dashed, minimum size =1cm] (a42) [left of=a43] {$?$};  
            \node[circle, draw, dashed, minimum size =1cm] (a41) [left of=a42] {$?$};  
            \node[circle, draw, dashed, minimum size =1cm] (a40) [left of=a41] {$?$};  
    
            \draw [decorate,decoration={brace,amplitude=10pt, raise =1cm}]
            (a40.center) -- (a42.center) node [yshift=1.5cm,midway] 
            {$\delta$-day grace period};

            \node[circle,draw,minimum size =1cm] (a53) [left of=y5] {$0$};
            \node[circle, draw, minimum size =1cm] (a52) [left of=a53] {$0$};  
            \node[circle, draw, minimum size =1cm] (a51) [left of=a52] {$0$};  
            \node[circle, draw, minimum size =1cm] (a50) [left of=a51] {$0$};  
    
            \node[regular polygon,regular polygon sides=4, draw,fill=gray!30,minimum size =1.25cm] (l30) [below left=0.01cm and 1.5cm of a40] {$ $};  
        
            \path[->] (l30) edge node {} (a40);
            \path[->] (l30) edge node {} (a50);
        
            \path[->] (a40) edge node {} (a41);
            \path[->] (a50) edge node {} (a51);
            \path[->] (a41) edge node {} (a42);
            \path[->] (a51) edge node {} (a52);
            \path[->] (a42) edge node {} (a43);
            \path[->] (a52) edge node {} (a53);
            \path[->] (a43) edge node {} (y4);
            \path[->] (a53) edge node {} (y5);
    
            \end{tikzpicture}
            \caption{Schematic of trials with a grace period, participants are randomized to a strategy starting on day zero and given a fixed length time window in which they can initiate and then sustain thereafter.}
            \label{fig:design3}
    \end{figure}

    \clearpage

    \subsection{Adjusting trial outcomes based on biology}
    Sometimes there is strong biological theory or evidence about the postexposure window in which vaccination is likely to be most successful, for instance, when data from postvaccination serological assessments of antibody responses suggests meaningful change in immune responses occurs only after 7 days. In this case, there may be interest in restricting the time frame in which events count against vaccination. In a trial, this may be handled by re-defining the outcome such that only cases which occur after 7 days are counted as events. Cases that occur prior to this are not counted in either trial arm. This is how outcomes were defined, for instance, in many of the trials of SARS-CoV-2 vaccines. 
        
    In observational emulations, we can similarly re-define vaccination outcomes based on biology, however we have to be careful to ensure that the new definitions are applied fairly across vaccination groups. In traditional analyses, bias can occur when all unvaccinated cases are counted from day zero but vaccinated cases are counted from the day of vaccination. This is fixed when using either the sequential daily trials or the clone-censor-weighting approaches described previously because time zero is properly aligned in both groups.

    \subsection{Measures of vaccine efficacy}
    In the main text, we defined vaccine efficacy in terms of the cumulative incidence of symptoms or disease over the follow up period, e.g.
    $$
    VE(t) = 1 - \frac{\Pr[Y^{x=t} = 1]}{\Pr[Y^{x > \Delta} = 1]}
    $$ 
    comparing vaccination regimes vaccinated on day $t$ and never vaccinated over follow up. However, it is also common in the literature to see vaccine efficacy defined instead in terms of hazards, e.g.
    $$
    VE_\lambda(t) = 1 - \frac{\lambda^{x=t}(t)}{\lambda^{x > \Delta}(t)}
    $$ 
    where $\lambda(t)$ is the (average) hazard rate over the follow up period. In the applied literature, these are sometimes used interchangeably even though they will rarely coincide, e.g. they will not coincide when hazard rates are nonconstant or heterogeneous or nonproportional. In the causal literature, there is a preference against causal hazard ratios particularly when they are time-varying (as they almost certainly are in practice) as they condition on survival and therefore introduce possible selection bias by construction. 

    However, in their seminal work, Smith et al showed that patterns in $VE(t)$ and $VE_\lambda(t)$ could, in some circumstances, help elucidate the mechanism of action of a particular vaccine, for instance to help distinguish whether a vaccine produces ``all-or-none'' or ``leaky'' protection against infection. 

    \subsection{Determining maximum postexposure vaccination delay} \label{sec:maxdelay}
    When setting guidelines for postexposure vaccination, a common problem is determining the maximum vaccination delay before efficacy falls below a certain cost-benefit threshold. This quantity is important both for policymakers communicating with high risk groups and the broader public about what to do in the event of an exposure as well as to help practitioners determine whether vaccination is still indicated upon presentation. Absent clear biology or immune response data, it can be difficult to determine empirically even when postexposure trials are possible as trial participants are generally only assigned to vaccine or no vaccine/placebo not to a specific day to be vaccinated. In this section, we suggest a methods for estimating the maximum delay based on a pre-specified minimum efficacy bound. In principle, these methods could be applied either in a randomized trial where the day of vaccination is not strictly controlled or in an observational emulation. 
 
    Suppose $u(Y^x, t)$ is a utility function quantifying the health benefits of vaccination on postexposure day $x$ of a person who is symptom-free at time $t$. If $V$ is a subset or possibly all of baseline covariates $L_0$ defining a subpopulation of interest, such as certain high risk exposure groups, then the conditional mean
    $$m(x, t, v) \equiv E[u(Y^x, t) \mid V = v]$$
    is the expected utility under a hypothetical policy in which everyone in the subpopulation receives vaccination prior to $x$ viewed from the perspective of time $t$. Comparing the expected utility $m(x, t, v)$ for different values of $x$ quantifes the casual effect of interest. To determine the optimal guidance regarding postexposure delays, we want to find the maximum value of $x$ in which 
    utility in the subpopulation of interest remains above some minimum viable threshold viewed from $t$, i.e.
    $$x_{opt}(v, t) \equiv \operatorname{argmax}_{x \in \mathcal{X}} \{m(x, t, v) \geq \theta_{min} \}$$
    
    A simple example of $m(x, t, v)$ is the vaccine efficacy if everyone were vaccinated on day $x$ among those with $T > t$ in the full population, i.e. $VE(x^*, t)$, where
    $$VE(x^*, t) \equiv 1 - \frac{\Pr[Y^{x=x^*} = 1 \mid T > t]}{\Pr[Y^{x > \Delta} = 1 \mid T > t]}$$
    in which case we want to solve  
    $$x_{opt}(t) = \operatorname{argmax}_{x^* \in \mathcal{X}} \{VE(x^*, t) \geq \theta_{min} \}$$
    Two interesting values of $t$ to consider are:
    \begin{enumerate}
        \item $VE(x^*, 0)$, that is the effectiveness after a delay of $x^*$ days viewed from the perspective of everyone still at risk at time 0. 
        \item $VE(x^*, x^*)$, that is the effectiveness of getting vaccinated today among those symptom-free at time $t = x^*$.
    \end{enumerate}
    Each answers a slightly different question and may be relevant under different circumstances. The second is more relevant for practitioners counseling patients who present symptom-free on their options after exposure, while the first is more relevant for public health guidance telling those currently unexposed how quickly they need to get to a clinic after exposure. 

    To determine the maximum delay conditional on survival, one approach would be to use the stratified estimates $\widehat{VE}_{T > t}(t)$ from each of the nested daily trial emulations as $VE_{T > t}(t) = VE(x^*, x^*)$ for $t = x^*$ and then determine the maximum value of $t$ where  $\widehat{VE}_{T > t}(t)$ remains above the threshold. However, this assumes we observe sufficient numbers of individuals being vaccinated on each day to obtain reliable estimates. In practice, we might prefer to increase efficiency by pooling across trials and fitting a model such as that in \ref{eqn:fixed}. We can then estimate the $\widehat{VE}_{T > t}(t)$ curve either from estimated hazard ratios or from standardized cumulative incidence curves depending on effect measure of interest and using inverse probability of censoring weights to adjust for nonadherence among unvaccinated where applicable.

    To determine the maximum day zero delay, again one approach would be to calculate $\widehat{VE}(t)$ separately by comparing each delay strategy to the ``never vaccinate'' strategy from the day zero trial emulation with multiple strategies as $VE(t) = VE(x^*, 0)$ and then determine the maximum value of $t$ where  $\widehat{VE}(t)$ remains above the threshold. However,  we can also increase efficiency by pooling across trials and fitting a model such as that in \ref{eqn:dayzero}. Again, we can then estimate the $\widehat{VE}(t)$ curve either from estimated hazard ratios or from standardized cumulative incidence curves depending on effect measure of interest and using inverse probability of censoring weights to adjust for nonadherence among unvaccinated where applicable.
    
    % $$VE^x(t) = 1 - \frac{\sum_{t=0}^\Delta \Pr[D^{x}_{t+1} = 1 \mid \overline{D}^x_t = 0] \prod_{j=0}^t\Pr[D^{x}_{j+1} = 0 \mid \overline{D}^x_j = 0]}{\sum_{t=0}^\Delta \Pr[D^{\infty}_{t+1} = 1 \mid \overline{D}^\infty_t = 0] \prod_{j=0}^t\Pr[D^{\infty}_{j+1} = 0 \mid \overline{D}^\infty_j = 0]}$$

    

    % \subsection{Heterogeneity in vaccine effectiveness  }
    
    \subsection{Additional simulation details}
    
    As discussed in main text, we simulated postexposure vaccination times by drawing $X^*$ from a Poisson distribution with a mean of 5 days and then drawing an ``assignment'' indicator $Z$ from a Bernoulli distribution with probability 0.5. This mimics a trial in which vaccination timing is not controlled by investigators, but participants are randomized on the day they present. In the observational study, however we only observe the vaccination times among the vaccinated, i.e. $X = ZX^* $. We simulated symptom onset over the 21 days of follow up based on the discrete time hazard model 
    $$\Pr[D_k = 1 \mid \overline{D}_{k-1} = 0, X] =  \text{expit}\{\alpha_{0,k} + \log(1 - VE_{\lambda}(X)) \cdot I(X < k)\}$$
    for $k$ in $\{1, \ldots, 21\}$ where $Y = D_{21}$, $T = 21 - \sum_{k=0}^K D_k$, and the baseline hazard $\alpha_{0,k}$ was defined such that there is a 50\% probability of symptoms given exposure among unvaccinated and onset times among cases had a log-normal distribution with parameters chosen based on previous estimates of the incubation period for mpox. Figure \ref{fig:sim_overlap} shows the overlap in the distribution of vaccination times and disease onset times. We censor both after 21 days. We assumed vaccination reduces probability of symptoms but does not affect onset timing and only works if administered prior to onset. For those with simulated vaccination times that occur after symptom onset we assumed 25\% still receive the vaccine, while vaccination time was censored for the remaining. The full data generation process may be written as:
    \begin{align*}
        X^* & \sim \text{Poisson}(5) \\
        Z & \sim \text{Bernoulli}(0.5) \\
        W & \sim \text{Bernoulli}(0.25) \\
        \text{for } k \in \{1, \ldots, 21\}: \; D_k & \sim \text{Bernoulli}(\text{expit}\{\alpha_{0,k} + \log(1 - VE_{\lambda}(X^*)) \cdot Z \cdot I(X^* < k)\}\}) \\
        T &= 21 - \sum_{k=1}^{21} D_k \\
        X &= Z \cdot X^* \cdot I(X^* < T) + W \cdot Z \cdot X^* \cdot I(X^* \geq T) \\
        Y &= D_{21}
    \end{align*}
    where 
    $$\alpha_{0,k} = \operatorname{logit}\left[0.25 \cdot \frac{\Phi(k) - \Phi(k -1)}{1 - \Phi(k-1)}\right]$$
    and $\Phi$ is the cumulative distribution function for a log-normal distribution with log mean of 2.1 and log standard deviation of 0.59.

    We generated data under three scenarios for vaccine efficacy:
    \begin{itemize}
        \item Scenario 1: the null case where postexposure vaccination is completely ineffective $VE_\lambda(x) = 0$.
        \item Scenario 2: vaccination reduces hazard of symptom onset by a constant of 40\%, i.e. $VE_\lambda(x) = 0.4$ (corresponding to 21-day VE of 31.6\% based on cumulative incidence).
        \item Scenario 3: a more realistic scenario in which efficacy is a function of postexposure timing $VE_{\lambda}(x) = 0.8/[1+\exp\{0.75(x-4)\}]$
    \end{itemize}
    
    In the main text, we estimated vaccine efficacy using three different strategies:
    \begin{enumerate}
        \item \textit{naive, leave} - a simple comparison of the ``ever vaccinated'' and ``never vaccinated'' using the relative risk regression model $\Pr[Y = 1 \mid X] = \operatorname{exp}\{\beta_0 + \beta_1 I(X < 21)\}$ and vaccine efficacy is estimated as $\widehat{VE} = 1 - \exp(\widehat{\beta_1})$.
        \item \textit{naive, move} - those who receive vaccine after developing symptoms are re-classified as ``unvaccinated'', i.e. we use the relative risk regression model $\Pr[Y = 1 \mid X] = \operatorname{exp}\{\beta_0 + \beta_1 I(X < T)\}$ where $I(X<T)$ implies only those who receive vaccine prior to symptom onset are ``vaccinated'' and vaccine efficacy is estimated as $\widehat{VE} = 1 - \exp(\widehat{\beta_1})$ as before.
        \item \textit{target trial} - we emulate a sequence of nested daily trials by taking those who are symptom free and unvaccinated prior to start and compare those are vaccinated on that day to those who are not. In each trial, we censor the unvaccinated when they become vaccinated and use inverse-probability of censoring weights to account for informative censoring. These nested trials are combined and vaccine effectiveness is estimated using standardized cumulative incidence curves from a pooled logistic regression and standard errors are estimated using cluster-robust variance estimator.
    \end{enumerate}
    The first two are strategies that we have seen used in observational studies of post-exposure vaccination and the last is the one proposed in this paper.

    In the appendix, we consider additional strategies for estimating vaccine efficacy based on the hazard rather than the cumulative incidence of symptom onset, specifically:
    \begin{enumerate}
        \item \textit{naive, leave} - similar to above however we estimate incidence rates rather than cumulative incidence through poisson regression $\Pr[Y = 1 \mid X] = \operatorname{exp}\{\beta_0 + \beta_1 I(X < 21)\}$ with offset $\log(T)$ and vaccine efficacy is estimated as $\widehat{VE} = 1 - \exp(\widehat{\beta_1})$.
        \item \textit{naive, move} - those who receive vaccine after developing symptoms are re-classified as ``unvaccinated'', i.e. we use the poisson regression model $\Pr[Y = 1 \mid X] = \operatorname{exp}\{\beta_0 + \beta_1 I(X < T)\}$ with offset $\log(T)$ and $I(X<T)$ implies only those who receive vaccine prior to symptom onset are ``vaccinated'' and vaccine efficacy is estimated as $\widehat{VE} = 1 - \exp(\widehat{\beta_1})$ as before.
        \item \textit{time-varying cox} - use a time-varying cox model $\lambda(t|X) = \lambda_0(t) \exp\{\beta_1 I(X \geq t)\}$ in which follow up time is split for vaccinated participants at the time of vaccination. Prior to this their person time is classified as unvaccinated and efficacy is estimated as $\widehat{VE} = 1 - \exp(\widehat{\beta_1})$.
        \item \textit{target trial} - same as previous, except  we estimate vaccine efficacy as one minus the exponentiated coefficient from the pooled logistic regression model rather than from standardized cumulative incidence curves.
    \end{enumerate}

    In each Monte Carlo simulation, we draw datasets of size 1000 from the process above under each efficacy scenario, estimated the $VE$ using the estimation strategies described, and repeated the process 1000 times. We calculate absolute and relative bias, mean squared error, and confidence interval coverage.

    \subsection{Additional simulation results}

    In this section, we present additional results from our simulation of stratgies to estimate postexposure vaccine efficacy. 

    \begin{itemize}
        \item Tables \ref{tab:sim_results_rr} and \ref{tab:sim_results_hr} show the full simulation results for scenarios 1 and 2 when the efficacy is estimated using the risk ratio and the hazard ratio.
        \item Figure \ref{fig:sim_hetx} shows the performance of the estimation strategies outlined in the previous section when the vaccine efficacy varies with postexposure delay. 
        \item Figure \ref{fig:sim_hr} compares performance of the estimation strategies when efficacy is based on the hazard rather than the cumulative incidence of symptom onset.
        \item Figure \ref{fig:sim_overlap} shows how performance varies with the degree of overlap between vaccination and symptom onset. Specifically, we varied the mean of the log-normal distribution used to generate the symptom onset times, with larger means corresponding to later symptom onset and thus less overlap.
    \end{itemize}

    \begin{table}[p]
        \centering
        \caption{Simulation results for scenarios 1 and 2 when estimating VE using risk ratio}\label{tab:sim_results_rr}
        \input{../2_tables/sim_results_rr.tex}
    \end{table}

    \begin{table}[p]
        \centering
        \caption{Simulation results for scenarios 1 and 2 when estimating VE using hazard ratio}\label{tab:sim_results_hr}
        \input{../2_tables/sim_results_hr.tex}
    \end{table}

    \clearpage

    \begin{figure}[p]
        \centering
        \includegraphics{../3_figures/sim_hetx.pdf}
        \caption{Comparison of estimators under when vaccine efficacy varies by postexposure administration time.\label{fig:sim_hetx}}
    \end{figure}

    \begin{figure}[p]
        \centering
        \includegraphics{../3_figures/sim_hr.pdf}
        \caption{Comparison of estimators when calculating vaccine efficacy using the hazard ratio instead of the risk ratio.\label{fig:sim_hr}}
    \end{figure}

    \begin{figure}[p]
        \centering
        \includegraphics{../3_figures/sim_overlap.pdf}
        \caption{Bias of naive methods varies with degree of overlap between vaccination delays and symptom onset times.\label{fig:sim_overlap}}
    \end{figure}

    
    \clearpage
    % An additional complication is whether participants are screened for symptoms or PCR-positivity at enrollment and those with signs of clinical disease are excluded, in which case the regime is 
% $$
% g(X,\delta): \text{get vaccinated within $\delta$ days of exposure under }  f^*(X \mid \overline{L}_t, X > t, T > t)
% $$

% Pooled grace period:
% $$\overline{VE}_\delta = \sum_{t = 1}^\delta \left\{ 1 - \frac{\Pr[Y^{x = t} = 1]}{\Pr[Y^{x > \Delta} = 1 ]}\right\} \Pr[X = t].$$

% Pooled daily trials:

% $$\overline{VE}_\delta = \sum_{t = 1}^\delta \left\{ 1 - \frac{\Pr[Y^{x = t} = 1 \mid X = t, T > t]}{\Pr[Y^{x > \Delta} = 1 \mid X = t, T > t]}\right\} \Pr[X = t, T > t].$$

% \begin{table}[p]
%     \small
%     \centering
%     \caption{}
%     \begin{tabular}{>{\raggedright\arraybackslash}p{3cm}>{\raggedright\arraybackslash}p{4cm}>{\raggedright\arraybackslash}p{4cm}>{\raggedright\arraybackslash}p{4cm}}
%         \toprule
%         Estimand & Treatment strategies & Target trial design & Emulation \\
%         \midrule
%         $VE(0)$ & & & \\
%         $VE(t)$ & & & \\
%         $\overline{VE}_\delta$ & & & \\
%         $VE(t \mid X = t)$ & & & \\
%         \bottomrule
%     \end{tabular}
% \end{table}
% \clearpage     

    
    
\end{appendix}